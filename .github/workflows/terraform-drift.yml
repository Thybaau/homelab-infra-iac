name: Terraform Drift Detection

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1" # Tous les lundis à 8h

env:
  TF_VAR_proxmox_api_url: ${{ secrets.PM_API_URL }}
  TF_VAR_proxmox_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
  TF_VAR_proxmox_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}
  TF_VAR_ssh_public_keys: ${{ secrets.SSH_PUBLIC_KEYS }}

jobs:
  drift:
    name: Detect Configuration Drift
    runs-on: self-hosted # OBLIGATOIRE: Proxmox n'est pas accessible depuis Internet

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Verify State Exists
        run: |
          if [ ! -f "/var/lib/terraform/states/homelab-infra.tfstate" ]; then
            echo "⚠️  Aucun state trouvé. Infrastructure probablement pas encore déployée."
            echo "Exécutez d'abord le workflow 'Terraform Apply'."
            exit 0
          fi
          echo "✅ State trouvé, vérification du drift..."

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan (Drift Check)
        id: plan
        run: terraform plan -detailed-exitcode -no-color
        continue-on-error: true

      - name: Analyze Drift
        run: |
          if [ ${{ steps.plan.outcome }} == 'failure' ]; then
            echo "⚠️ DRIFT DÉTECTÉ! Des modifications manuelles ont été effectuées."
            echo "Consultez les logs ci-dessus pour les détails."
            exit 1
          else
            echo "✅ Aucune dérive détectée. Infrastructure conforme."
          fi

      - name: Create Issue on Drift
        if: steps.plan.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Configuration Drift Détecté',
              body: 'Des modifications manuelles ont été détectées dans l\'infrastructure Proxmox. Consultez le workflow pour les détails.',
              labels: ['infrastructure', 'drift']
            })
