name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Tapez "DESTROY" pour confirmer la destruction'
        required: true
        type: string

env:
  TF_VAR_proxmox_api_url: ${{ secrets.PM_API_URL }}
  TF_VAR_proxmox_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
  TF_VAR_proxmox_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}
  TF_VAR_ssh_public_keys: ${{ secrets.SSH_PUBLIC_KEYS }}

jobs:
  destroy:
    name: Terraform Destroy
    runs-on: self-hosted # OBLIGATOIRE: Proxmox n'est pas accessible depuis Internet

    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "‚ùå Confirmation invalide. Destruction annul√©e."
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Verify State Exists
        run: |
          if [ ! -f "/var/lib/terraform/states/homelab-infra.tfstate" ]; then
            echo "‚ùå Aucun state trouv√©. Rien √† d√©truire."
            exit 1
          fi
          echo "‚úÖ State trouv√©, pr√©paration de la destruction..."

      - name: Terraform Init
        run: terraform init

      - name: Terraform Destroy
        run: terraform destroy -auto-approve

      - name: Backup State Before Deletion
        if: always()
        run: |
          BACKUP_DIR="/var/lib/terraform/backups"
          STATE_FILE="/var/lib/terraform/states/homelab-infra.tfstate"
          sudo mkdir -p "$BACKUP_DIR"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          if [ -f "$STATE_FILE" ]; then
            cp "$STATE_FILE" \
               "$BACKUP_DIR/terraform.tfstate.destroyed.$TIMESTAMP" || true
            echo "‚úÖ State sauvegard√© avant suppression"
          fi

      - name: Confirm Destruction
        run: |
          echo "### üóëÔ∏è Infrastructure d√©truite avec succ√®s"
          echo "Toutes les VMs ont √©t√© supprim√©es de Proxmox."
          echo ""
          echo "‚ö†Ô∏è  Le state file a √©t√© conserv√© dans les backups au cas o√π."
